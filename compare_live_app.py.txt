import streamlit as st
import pandas as pd
import re
import time
from selenium import webdriver
from selenium.webdriver.chrome.options import Options
from bs4 import BeautifulSoup

st.set_page_config(page_title="ì‹¤ì‹œê°„ íƒ€ì„í…Œì´ë¸” ë¹„êµ ë„êµ¬", layout="wide")

st.title("ğŸŒï¸â€â™‚ï¸ ì‹¤ì‹œê°„ íƒ€ì„í…Œì´ë¸” ë¹„êµ ë„êµ¬ (ê³¨í”„ì¡´ì¹´ìš´í‹°)")

st.write("""
ì´ ë„êµ¬ëŠ” **ê³¨í”„ì¡´ì¹´ìš´í‹° ì˜ˆì•½ í˜ì´ì§€**ì˜ ì‹¤ì‹œê°„ ì •ë³´ë¥¼ ìë™ìœ¼ë¡œ í¬ë¡¤ë§í•˜ê³ ,  
ì‚¬ìš©ìê°€ ë¶™ì—¬ë„£ì€ íƒ€ì„í…Œì´ë¸” í…ìŠ¤íŠ¸ì™€ ë¹„êµí•©ë‹ˆë‹¤.
""")

# ì…ë ¥ UI
url = st.text_input("ğŸ”— ê³¨í”„ì¡´ì¹´ìš´í‹° ì˜ˆì•½ í˜ì´ì§€ URL ì…ë ¥:")
user_text = st.text_area("ğŸ“‹ ë‚´ íƒ€ì„í…Œì´ë¸” í…ìŠ¤íŠ¸ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”:", height=300)

if st.button("ğŸš€ ë¹„êµ ì‹œì‘"):
    if not url or not user_text:
        st.warning("URLê³¼ í…ìŠ¤íŠ¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.")
        st.stop()

    # 1ï¸âƒ£ Seleniumìœ¼ë¡œ í˜ì´ì§€ í¬ë¡¤ë§
    st.info("â³ í™ˆí˜ì´ì§€ì—ì„œ ì˜ˆì•½ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤... (ì•½ 10ì´ˆ ì†Œìš”)")
    try:
        options = Options()
        options.add_argument("--headless")
        options.add_argument("--no-sandbox")
        options.add_argument("--disable-dev-shm-usage")

        driver = webdriver.Chrome(options=options)
        driver.get(url)
        time.sleep(5)

        html = driver.page_source
        driver.quit()

        soup = BeautifulSoup(html, "html.parser")
        items = soup.find_all("li", class_="selectGc")

        site_data = []
        for item in items:
            source = item.get("data-cc_name", "").strip()
            course = item.get("data-course_name", "").strip()
            time_ = item.get("data-tee_time", "").strip()
            price = item.get("data-price4", "").strip()
            if all([course, time_, price]):
                site_data.append([source, course, time_, price])

        df_site = pd.DataFrame(site_data, columns=["source", "course", "time", "price"])
        st.success(f"âœ… {len(df_site)}ê°œì˜ ìŠ¬ë¡¯ì„ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤.")
        st.dataframe(df_site)

    except Exception as e:
        st.error(f"í¬ë¡¤ë§ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
        st.stop()

    # 2ï¸âƒ£ í…ìŠ¤íŠ¸ ë°ì´í„° íŒŒì‹±
    st.info("ğŸ“‹ í…ìŠ¤íŠ¸ ë°ì´í„° íŒŒì‹± ì¤‘...")
    try:
        pattern = re.compile(r"(\d{2,4})\s*ì¹´í¬\s*([\d.]+)ë§Œ")
        lines = user_text.splitlines()

        parsed = []
        current_date, current_course = None, None

        for line in lines:
            line = line.strip()
            if not line:
                continue
            # ë‚ ì§œ ê°ì§€
            if re.match(r"^\d{1,2}/\d{1,2}", line):
                current_date = line
            # ì½”ìŠ¤ëª… ê°ì§€
            elif line.startswith("*"):
                current_course = re.sub(r"[*()]|\d+ì¸|ë§ˆê°", "", line).strip()
            else:
                matches = pattern.findall(line)
                for t, p in matches:
                    time_str = f"{t[:2]}:{t[2:]}" if len(t) == 4 else f"{t[:2]}:{t[2:]}"
                    price_val = float(p) * 10000
                    parsed.append([current_date, current_course, time_str, int(price_val)])

        df_user = pd.DataFrame(parsed, columns=["date", "course", "time", "price"])
        st.success(f"âœ… {len(df_user)}ê°œì˜ ë‚´ íƒ€ì„í…Œì´ë¸” í•­ëª© íŒŒì‹± ì™„ë£Œ.")
        st.dataframe(df_user)

    except Exception as e:
        st.error(f"í…ìŠ¤íŠ¸ íŒŒì‹± ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
        st.stop()

    # 3ï¸âƒ£ ë¹„êµ
    st.info("ğŸ” ë°ì´í„° ë¹„êµ ì¤‘...")
    try:
        df_site["price"] = pd.to_numeric(df_site["price"], errors="coerce")
        df_compare = pd.merge(
            df_user, df_site,
            how="outer",
            on=["course", "time"],
            suffixes=("_my", "_site")
        )

        def compare_status(row):
            if pd.isna(row["price_my"]): return "í™ˆí˜ì´ì§€ì—ë§Œ ìˆìŒ"
            if pd.isna(row["price_site"]): return "ë‚´ ë°ì´í„°ì—ë§Œ ìˆìŒ"
            if row["price_my"] != row["price_site"]: return "ê°€ê²© ë‹¤ë¦„"
            return "ì¼ì¹˜"

        df_compare["ë¹„êµê²°ê³¼"] = df_compare.apply(compare_status, axis=1)
        st.success("âœ… ë¹„êµ ì™„ë£Œ!")
        st.dataframe(df_compare.sort_values(["course", "time"]).reset_index(drop=True), use_container_width=True)

        csv = df_compare.to_csv(index=False).encode("utf-8-sig")
        st.download_button("ğŸ“¥ ë¹„êµ ê²°ê³¼ CSV ë‹¤ìš´ë¡œë“œ", data=csv, file_name="ë¹„êµê²°ê³¼.csv", mime="text/csv")

    except Exception as e:
        st.error(f"ë¹„êµ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
